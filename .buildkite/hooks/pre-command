#!/usr/bin/env bash
##  This script prepares the Vault context and required tooling
##  for the release and snapshot pipelines.
##
##  NOTE: *_SECRET or *_TOKEN env variables are masked, hence if you'd like to avoid any
##        surprises please use the suffix _SECRET or _TOKEN for those values that contain
##        any sensitive data. Buildkite can mask those values automatically

set -eo pipefail

if [[ "$BUILDKITE_COMMAND" =~ .*"upload".* ]]; then
  echo "Skipped pre-command when running the pipeline upload command."
  exit 0
fi

case ${BUILDKITE_PIPELINE_NAME} in
  "apm-agent-java-release" | "apm-agent-java-snapshot")
    . .buildkite/scripts/setup-release-snapshot-vault-secrets.sh
    . .buildkite/scripts/install-java.sh
    .buildkite/script/setup-git.sh
  ;;
  "apm-agent-java-load-testing")
    . .buildkite/scripts/setup-load-testing-vault-secrets.sh
    . .buildkite/scripts/install-java.sh
  ;;
  *)
    echo "Unhandled pipeline: ${BUILDKITE_PIPELINE_NAME}"
    exit 1
esac
